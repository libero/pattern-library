const fs = require('fs');
const minimist = require('minimist');
const path = require('path');


// Needs node 8+
const {promisify} = require('util');

const readFileAsync = promisify(fs.readFile);

async function getConfigData(filePath) {
  const rawFileData = await readFileAsync(filePath, {encoding: 'utf8'});
  return JSON.parse(rawFileData);
}

function getBreakpoints(data) {
  return data.breakpoints;
}

function processBreakpointsForSass(breakpointData) {
  const processed = breakpointData.map((breakpoint) => {
    return `$${breakpoint.name}: ${breakpoint.threshold};`;
  });
  return processed.join('\n');
}

function writeSassBreakpoints(breakpointData) {
  const sassBreakpoints = processBreakpointsForSass(breakpointData);

  fs.writeFile(path.join(__dirname, paths.out.sass), sassBreakpoints, (err) => {
    if (err) {
      throw err;
    }

    console.log(`sass breakpoints written to ${ paths.out.sass}`);
  });
}

function getConfigPath(invocationArgs) {
  const sharedConfigLocalPath = minimist(
    invocationArgs, {
      default: {
        sharedConfig: './shared-config.json'
      }
    }
  )['sharedConfig'];

  return path.join(__dirname, `../${sharedConfigLocalPath}`);
}


const paths = {
  sharedConfig: getConfigPath(process.argv),
  out: {
    sass: '../source/css/sass/_variables--breakpoints-autogenerated.scss'
  }
};

function distribute() {
  getConfigData(paths.sharedConfig).then((data) => {
    const breakpointData = getBreakpoints(data);
    writeSassBreakpoints(breakpointData);
  });
}

module.exports = distribute;
