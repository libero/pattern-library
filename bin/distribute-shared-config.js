const fs = require('fs');
const minimist = require('minimist');
const path = require('path');


// Needs node 8+
const {promisify} = require('util');

const readFileAsync = promisify(fs.readFile);

async function getConfigData(filePath) {
  const rawFileData = await readFileAsync(filePath, {encoding: 'utf8'});
  return JSON.parse(rawFileData);
}

function getBreakpoints(data) {
  return data.breakpoints;
}

function processBreakpointsForSass(breakpointData) {
  const processed = breakpointData.map((breakpoint) => {
    return `$${breakpoint.name}: ${breakpoint.threshold};`;
  });
  return `${processed.join('\n')}\n`;
}

function processBreakpointsForJs(breakpointData) {

  const formatName = function formatName(name) {
    return (name.replace(/^bkpt-site--/, '')).replace( /-[a-z]/g,(match) => {
      return match.toUpperCase().substring(1);
    } );
  };

  const wrapper = {
    breakpoints: {}
  };

  breakpointData.forEach((breakpoint) => {
    wrapper.breakpoints[formatName(breakpoint.name)] = breakpoint.threshold;
  });

  return JSON.stringify(wrapper);
}

function writeSassBreakpoints(breakpointData) {
  const sassBreakpoints = processBreakpointsForSass(breakpointData);

  fs.writeFile(path.join(__dirname, paths.out.sass), sassBreakpoints, (err) => {
    if (err) {
      throw err;
    }

    console.log(`sass breakpoints written to ${ paths.out.sass}`);
  });
}

function writeJsBreakpoints(breakpointData) {
  const jsBreakpoints = processBreakpointsForJs(breakpointData);

  fs.writeFile(path.join(__dirname, paths.out.js), jsBreakpoints, (err) => {
    if (err) {
      throw err;
    }

    console.log(`js breakpoints written to ${ paths.out.js}`);
  });
}

function getConfigPath(invocationArgs) {
  const sharedConfigLocalPath = minimist(
    invocationArgs, {
      default: {
        sharedConfig: './shared-config.json'
      }
    }
  )['sharedConfig'];

  return path.join(__dirname, `../${sharedConfigLocalPath}`);
}


const paths = {
  sharedConfig: getConfigPath(process.argv),
  out: {
    js: '../source/js/config--breakpoints-autogenerated.json',
    sass: '../source/css/sass/_variables--breakpoints-autogenerated.scss'
  }
};

function distribute() {
  getConfigData(paths.sharedConfig).then((data) => {
    const breakpointData = getBreakpoints(data);
    writeSassBreakpoints(breakpointData);
    writeJsBreakpoints(breakpointData);
  });
}

module.exports = {
  distribute,
  getConfigPath,
  processBreakpointsForJs,
  processBreakpointsForSass
};
